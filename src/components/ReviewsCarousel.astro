---
// Reviews Carousel Component
// This component displays Google Business Profile reviews in a carousel format
// 
// To populate with Google reviews, you have a few options:
// 1. Use Google My Business API (requires API setup)
// 2. Use a third-party service (EmbedSocial, Elfsight, etc.)
// 3. Manually sync reviews periodically
// 4. Use a server-side API route to fetch reviews

export interface Props {
	reviews?: Array<{
		author: string;
		rating: number;
		text: string;
		date: string;
		authorImage?: string;
		reviewUrl?: string;
	}>;
	autoPlay?: boolean;
	showArrows?: boolean;
	showDots?: boolean;
	cardsPerView?: number; // Number of cards to show at once
}

const { 
	reviews = [], 
	autoPlay = true,
	showArrows = true,
	showDots = true,
	cardsPerView = 3 // Default: show 3 cards at once
} = Astro.props;

// Default reviews (replace with Google reviews when API is set up)
const defaultReviews = reviews.length > 0 ? reviews : [
	{
		author: "Jeremy Martel",
		rating: 5,
		text: "Shoreline Web Solutions took my business from just a basic Facebook page to a professional website that truly represents my work. The transformation has brought in more customers and given me the credibility I needed to grow my business.",
		date: "2024-01-15",
		authorImage: null,
		reviewUrl: null
	},
	{
		author: "Tayler Nadalny-Sipes",
		rating: 5,
		text: "I had absolutely no online presence before working with Shoreline Web Solutions. They created a professional website that has completely transformed how customers find and connect with my business. The difference in credibility and visibility has been incredible.",
		date: "2024-01-10",
		authorImage: null,
		reviewUrl: null
	}
];

const displayReviews = reviews.length > 0 ? reviews : defaultReviews;
---

<div class="reviews-carousel-container" data-cards-per-view={cardsPerView} style={`--cards-per-view: ${cardsPerView}`}>
	<div class="reviews-carousel-wrapper" data-autoplay={autoPlay}>
		<div class="reviews-carousel-track">
			{displayReviews.map((review, index) => (
				<div class="review-card" data-index={index}>
					<div class="bg-gradient-to-br from-blue-50 to-cyan-50 p-8 rounded-xl shadow-lg h-full">
						<!-- Star Rating -->
						<div class="flex items-center mb-4">
							<div class="flex text-yellow-400">
								{Array.from({ length: 5 }).map((_, i) => (
									<svg 
										class={`w-5 h-5 ${i < review.rating ? 'fill-current' : 'fill-none stroke-current'}`} 
										viewBox="0 0 20 20"
									>
										<path d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z"/>
									</svg>
								))}
							</div>
							{review.reviewUrl && (
								<a 
									href={review.reviewUrl} 
									target="_blank" 
									rel="noopener noreferrer"
									class="ml-2 text-blue-600 hover:text-blue-700 text-sm"
									aria-label="View on Google"
								>
									<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
										<path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
										<path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
										<path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>
										<path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
									</svg>
								</a>
							)}
						</div>
						
						<!-- Review Text -->
						<p class="text-slate-600 leading-relaxed mb-6 min-h-[100px]">
							"{review.text}"
						</p>
						
						<!-- Author Info -->
						<div class="flex items-center">
							{review.authorImage ? (
								<img 
									src={review.authorImage} 
									alt={review.author}
									class="w-12 h-12 rounded-full object-cover"
								/>
							) : (
								<div class="w-12 h-12 bg-gradient-to-r from-blue-600 to-cyan-600 rounded-full flex items-center justify-center text-white font-bold">
									{review.author.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2)}
								</div>
							)}
							<div class="ml-4">
								<h4 class="font-semibold text-slate-900">{review.author}</h4>
								<p class="text-slate-600 text-sm">
									{new Date(review.date).toLocaleDateString('en-US', { 
										year: 'numeric', 
										month: 'long', 
										day: 'numeric' 
									})}
								</p>
							</div>
						</div>
					</div>
				</div>
			))}
		</div>
	</div>
	
	<!-- Navigation Arrows -->
	{showArrows && displayReviews.length > 1 && (
		<div class="reviews-carousel-nav">
			<button 
				class="reviews-carousel-prev" 
				aria-label="Previous review"
			>
				<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
					<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
				</svg>
			</button>
			<button 
				class="reviews-carousel-next" 
				aria-label="Next review"
			>
				<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
					<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
				</svg>
			</button>
		</div>
	)}
	
	<!-- Dots Indicator -->
	{showDots && displayReviews.length > 1 && (
		<div class="reviews-carousel-dots">
			{displayReviews.map((_, index) => (
				<button 
					class="reviews-carousel-dot" 
					data-index={index}
					aria-label={`Go to review ${index + 1}`}
				></button>
			))}
		</div>
	)}
</div>

<style>
	.reviews-carousel-container {
		position: relative;
		max-width: 1200px;
		margin: 0 auto;
		padding: 0 60px; /* Space for navigation arrows */
	}
	
	.reviews-carousel-wrapper {
		position: relative;
		overflow: hidden;
		width: 100%;
	}
	
	.reviews-carousel-track {
		display: flex;
		transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
		will-change: transform;
		gap: 24px; /* Space between cards */
	}
	
	.review-card {
		flex: 0 0 calc((100% - (var(--cards-per-view, 3) - 1) * 24px) / var(--cards-per-view, 3));
		min-width: 0; /* Allow flex shrinking */
		padding: 0;
		box-sizing: border-box;
	}
	
	.reviews-carousel-nav {
		display: flex;
		justify-content: space-between;
		position: absolute;
		top: 50%;
		left: 0;
		right: 0;
		transform: translateY(-50%);
		pointer-events: none;
		z-index: 10;
	}
	
	.reviews-carousel-prev,
	.reviews-carousel-next {
		pointer-events: all;
		width: 48px;
		height: 48px;
		border-radius: 50%;
		background: white;
		border: 2px solid #e2e8f0;
		display: flex;
		align-items: center;
		justify-content: center;
		cursor: pointer;
		transition: all 0.3s ease;
		color: #475569;
		box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
	}
	
	.reviews-carousel-prev:hover,
	.reviews-carousel-next:hover {
		background: #f1f5f9;
		border-color: #cbd5e1;
		transform: scale(1.1);
	}
	
	.reviews-carousel-prev {
		left: 0;
		margin-left: -60px;
	}
	
	.reviews-carousel-next {
		right: 0;
		margin-right: -60px;
	}
	
	.reviews-carousel-dots {
		display: flex;
		justify-content: center;
		gap: 0.5rem;
		margin-top: 2rem;
	}
	
	.reviews-carousel-dot {
		width: 12px;
		height: 12px;
		border-radius: 50%;
		border: none;
		background: #cbd5e1;
		cursor: pointer;
		transition: all 0.3s ease;
		padding: 0;
	}
	
	.reviews-carousel-dot.active {
		background: #3b82f6;
		width: 32px;
		border-radius: 6px;
	}
	
	.reviews-carousel-dot:hover {
		background: #94a3b8;
	}
	
	@media (max-width: 1024px) {
		.reviews-carousel-container[data-cards-per-view="3"] .review-card {
			flex: 0 0 calc((100% - 24px) / 2); /* Show 2 cards on tablet */
		}
	}
	
	@media (max-width: 768px) {
		.reviews-carousel-container {
			padding: 0 50px;
		}
		
		.reviews-carousel-prev,
		.reviews-carousel-next {
			width: 40px;
			height: 40px;
		}
		
		.reviews-carousel-prev {
			margin-left: -50px;
		}
		
		.reviews-carousel-next {
			margin-right: -50px;
		}
		
		/* Show 1 card on mobile */
		.review-card {
			flex: 0 0 100% !important;
		}
	}
</style>

<script is:inline>
	function initReviewsCarousel() {
		const container = document.querySelector('.reviews-carousel-container');
		if (!container) return;
		
		const track = container.querySelector('.reviews-carousel-track');
		const cards = container.querySelectorAll('.review-card');
		const prevBtn = container.querySelector('.reviews-carousel-prev');
		const nextBtn = container.querySelector('.reviews-carousel-next');
		const dots = container.querySelectorAll('.reviews-carousel-dot');
		const wrapper = container.querySelector('.reviews-carousel-wrapper');
		const autoplay = wrapper && wrapper.getAttribute('data-autoplay') === 'true';
		const cardsPerView = parseInt(container.getAttribute('data-cards-per-view') || '3', 10);
		
		if (!track) {
			console.warn('Reviews carousel: track not found');
			return;
		}
		
		if (cards.length === 0) {
			console.warn('Reviews carousel: no review cards found');
			return;
		}
		
		console.log(`Reviews carousel initialized with ${cards.length} reviews, showing ${cardsPerView} cards per view`);
		
		let currentIndex = 0;
		let autoplayInterval = null;
		let isTransitioning = false;
		
		// Get the width of one card (including gap)
		function getCardWidth() {
			if (cards.length === 0) return 0;
			const card = cards[0];
			const cardRect = card.getBoundingClientRect();
			const trackRect = track.getBoundingClientRect();
			const gap = 24; // Gap between cards in pixels
			return cardRect.width + gap;
		}
		
		// Calculate max index based on cards per view
		function getMaxIndex() {
			return Math.max(0, cards.length - cardsPerView);
		}
		
		function slideToIndex(index) {
			// Clamp index to valid range
			const maxIndex = getMaxIndex();
			if (index < 0) index = 0;
			if (index > maxIndex) index = maxIndex;
			
			if (isTransitioning) return;
			isTransitioning = true;
			
			currentIndex = index;
			const cardWidth = getCardWidth();
			const translateX = -currentIndex * cardWidth;
			
			track.style.transform = `translateX(${translateX}px)`;
			
			// Update dots
			if (dots && dots.length > 0) {
				dots.forEach(function(dot, i) {
					if (i === index) {
						dot.classList.add('active');
					} else {
						dot.classList.remove('active');
					}
				});
			}
			
			// Reset transition lock after animation completes
			setTimeout(function() {
				isTransitioning = false;
			}, 600);
		}
		
		function nextCard() {
			const maxIndex = getMaxIndex();
			const nextIndex = currentIndex + 1;
			// Loop back to start if we've reached the end
			if (nextIndex > maxIndex) {
				slideToIndex(0);
			} else {
				slideToIndex(nextIndex);
			}
		}
		
		function prevCard() {
			const maxIndex = getMaxIndex();
			const prevIndex = currentIndex - 1;
			// Loop to end if we're at the start
			if (prevIndex < 0) {
				slideToIndex(maxIndex);
			} else {
				slideToIndex(prevIndex);
			}
		}
		
		function startAutoplay() {
			if (!autoplay) return;
			stopAutoplay(); // Clear any existing interval
			autoplayInterval = window.setInterval(nextCard, 5000);
		}
		
		function stopAutoplay() {
			if (autoplayInterval) {
				clearInterval(autoplayInterval);
				autoplayInterval = null;
			}
		}
		
		// Event listeners
		if (nextBtn) {
			nextBtn.addEventListener('click', function() {
				nextCard();
				stopAutoplay();
				startAutoplay();
			});
		}
		
		if (prevBtn) {
			prevBtn.addEventListener('click', function() {
				prevCard();
				stopAutoplay();
				startAutoplay();
			});
		}
		
		dots.forEach(function(dot, index) {
			dot.addEventListener('click', function() {
				slideToIndex(index);
				stopAutoplay();
				startAutoplay();
			});
		});
		
		// Pause autoplay on hover
		container.addEventListener('mouseenter', stopAutoplay);
		container.addEventListener('mouseleave', startAutoplay);
		
		// Handle window resize to recalculate card width
		let resizeTimeout;
		window.addEventListener('resize', function() {
			clearTimeout(resizeTimeout);
			resizeTimeout = setTimeout(function() {
				slideToIndex(currentIndex);
			}, 250);
		});
		
		// Initialize
		slideToIndex(0);
		startAutoplay();
	}
	
	// Initialize on page load
	if (document.readyState === 'loading') {
		document.addEventListener('DOMContentLoaded', initReviewsCarousel);
	} else {
		initReviewsCarousel();
	}
	
	// Re-initialize after Astro page transitions
	document.addEventListener('astro:page-load', initReviewsCarousel);
</script>

